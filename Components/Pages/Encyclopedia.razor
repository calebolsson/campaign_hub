@page "/encyclopedia"
@attribute [StreamRendering]
@rendermode InteractiveServer
@using DataAccessLibrary
@using DataAccessLibrary.Models
@inject ICharacterData _character_db
@inject ICampaignData _campaign_db
@inject IGuildData _guild_db

<PageTitle>Encyclopedia</PageTitle>

@* <h3>Add a character</h3> *@

@* <EditForm Model="@new_character">
    <input name="@new_character.first_name" />
    <button type="submit"></button>
</EditForm> *@

<h4></h4>

<div class="filter-menu">
    <button class="toolbtn"><i class="bi bi-funnel"></i></button>
    <div class="filter-item">
        <p>Category: </p><select>
            <option value="0">Character</option>
            <option value="1">Location</option>
            <option value="2">Guild</option>
            <option value="3">Event</option>
            <option value="4">Other</option>
        </select>
    </div>
    <div class="filter-item">
        <p>Campaign: </p><select class="campaign-selector">
            <option value="" selected disabled hidden>All Campaigns</option>
            @if (campaigns != null)
                @foreach (var campaign in campaigns)
                {
                    <option value="@campaign.Id">@campaign.Name</option>
                }
        </select>
    </div>
    <div class="filter-item">
        <p>Group By: </p><select>
            <option value="0">Name</option>
            <option value="1">Color</option>
            <option value="2">Guild</option>
            <option value="3">Class</option>
            <option value="4">Plane</option>
        </select>
    </div>
    @* <div class="filter-item">
        <p>Order By: </p><select>
            <option value="0">Ascending</option>
            <option value="1">Descending</option>
            <option value="2">Pick Values</option>
        </select>
    </div> *@
    <button class="toolbtn" @onclick="@asc_desc_toggle">
        <i class="@asc_desc_button"></i>
    </button>
</div>

<div id="dict-grid">

    @if ((characters is null) || (guilds is null))
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        @foreach (var character in characters)
        {
            <button class="entry">
                <img src=@character.img width="150" height="150">
                <div class="entryData">
                    <h2>@character.first_name @character.last_name</h2>
                    @if (character.tags is not null) foreach (string tag in ParseTags(character.tags))
                        {
                            <div class="tag" data=@tag><p>@tag</p></div>
                        }
                </div>
                <div class="panel">
                    <p>@character.description</p>
                </div>
            </button>
        }
        @foreach (var guild in guilds)
        {
            <button class="entry">
                <img src=@guild.Img width="150" height="150">
                <div class="entryData">
                    <h2>@guild.Name</h2>
                    @if (guild.Tags is not null) foreach (string tag in ParseTags(guild.Tags))
                        {
                            <div class="tag" data=@tag><p>@tag</p></div>
                        }
                </div>
                <div class="panel">
                    <p>@guild.Description</p>
                </div>
            </button>
        }
        <div class="tooltray">
            <button class="toolbtn exit_panel_btn">🗙</button>
            <button class="toolbtn">▲</button>
            <button class="toolbtn">▼</button>
            <button class="toolbtn">+</button>
            <button class="toolbtn"><i class="bi bi-funnel"></i></button>
        </div>


    }


</div>





@code {
    private List<CampaignModel>? campaigns;
    private List<CharacterModel>? characters;
    private List<GuildModel>? guilds;
    private CharacterModel? new_character { get; set; } = new();
    public string asc = "bi bi-sort-down";
    public string desc = "bi bi-sort-up-alt";
    public string asc_desc_button = "bi bi-sort-down";


    protected override async Task OnInitializedAsync()
    {
        characters = await _character_db.getCharacters();
        guilds = await _guild_db.getGuilds();
        campaigns = await _campaign_db.getCampaigns();
    }

    private List<string> ParseTags(string tags)
    {
        return tags.TrimEnd().Split(',').ToList();
    }

    public async Task asc_desc_toggle()
    {
        if (asc_desc_button.Equals(asc))
        {
            asc_desc_button = desc;
        }
        else if (asc_desc_button.Equals(desc))
        {
            asc_desc_button = asc;
        }
        // Notify that state has changed
        StateHasChanged();
        await Task.CompletedTask;
    }
}


@* @code {
    private WeatherForecast[]? forecasts;

    protected override async Task OnInitializedAsync()
    {
        // Simulate asynchronous loading to demonstrate streaming rendering
        await Task.Delay(500);

        var startDate = DateOnly.FromDateTime(DateTime.Now);
        var summaries = new[] { "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching" };
        forecasts = Enumerable.Range(1, 5).Select(index => new WeatherForecast
        {
            Date = startDate.AddDays(index),
            TemperatureC = Random.Shared.Next(-20, 55),
            Summary = summaries[Random.Shared.Next(summaries.Length)]
        }).ToArray();
    }

    private class WeatherForecast
    {
        public DateOnly Date { get; set; }
        public int TemperatureC { get; set; }
        public string? Summary { get; set; }
        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
    }
}
 *@